{"componentChunkName":"component---src-templates-blog-post-js","path":"/m1-mac-android-emulator-bluetooth-passthrough-bumble/","result":{"data":{"site":{"siteMetadata":{"title":"Boris's Blog"}},"markdownRemark":{"id":"011322ec-73d3-5565-acd3-379f57e99816","excerpt":"If you're a developer working with Bluetooth on an M1/M2/M3 Mac and trying to get your host machine's Bluetooth radio working inside the Android Emulator, you…","html":"<p>If you're a developer working with Bluetooth on an M1/M2/M3 Mac and trying to get your host machine's Bluetooth radio working inside the Android Emulator, you've probably felt some pain. What seems like it <em>should</em> be straightforward often turns into a frustrating rabbit hole of failed connections, cryptic errors, and documentation dead ends. I recently went through this exact battle, and after hitting multiple walls, I finally found a combination using the <strong>Bumble</strong> Python Bluetooth stack that <em>actually works</em>.</p>\n<p>This isn't just another theoretical guide; this is the blow-by-blow account of what failed and, more importantly, what <em>succeeded</em> in bridging my M1 Mac Pro's Bluetooth (via an external USB dongle in my case, but the principle might apply to internal radios) to an Android 12L (API 32) emulator.</p>\n<h2>The Goal: Real Bluetooth in the Emulator</h2>\n<p>The objective was simple: make the Android Emulator use my Mac's physical Bluetooth controller instead of its own limited virtual one. This is crucial for testing apps that interact with real-world Bluetooth devices.</p>\n<h2>The Tool: Enter Bumble</h2>\n<p><a href=\"https://github.com/google/bumble\">Bumble</a> is a powerful Python Bluetooth stack. Its key tool for this task is <code class=\"language-text\">bumble-hci-bridge</code>, which can connect to a physical HCI (Host Controller Interface) on one side and expose it via various transports (like TCP or gRPC) on the other.</p>\n<h2>Attempt #1: The QEMU Socket Method (The Logical First Try)</h2>\n<p>Based on general QEMU knowledge and some older guides, the first approach involved using emulator flags to directly connect a virtual serial port (backed by a TCP socket) to the HCI bridge.</p>\n<ol>\n<li>\n<p><strong>Start the Bridge (TCP Server Mode):</strong> We connected Bumble to the physical dongle (which surprisingly worked better with <code class=\"language-text\">usb:0</code> than its specific VID:PID <code class=\"language-text\">usb:0b05:17cb</code> on my machine – M1 quirks!) and made it listen on a TCP port.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># In Terminal 1:</span>\n<span class=\"token function\">sudo</span> python3 <span class=\"token parameter variable\">-m</span> bumble.apps.hci_bridge usb:0 tcp-server:0.0.0.0:6789\n<span class=\"token comment\"># Output showed '>>> connected' twice - success connecting to USB and starting TCP server.</span></code></pre></div>\n</li>\n<li>\n<p><strong>Launch Emulator with QEMU Flags:</strong> We modified the emulator launch script (targeting API 34 initially) to add <code class=\"language-text\">-qemu</code> flags directing a virtual serial port (<code class=\"language-text\">virtserialport</code>) to a character device (<code class=\"language-text\">chardev</code>) backed by a TCP socket connecting to the bridge.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># Snippet from launch script:</span>\nemulator <span class=\"token parameter variable\">-avd</span> <span class=\"token operator\">&lt;</span>avd_name<span class=\"token operator\">></span> <span class=\"token punctuation\">..</span>. <span class=\"token punctuation\">\\</span>\n    <span class=\"token parameter variable\">-qemu</span> <span class=\"token punctuation\">\\</span>\n    <span class=\"token parameter variable\">-device</span> virtio-serial-device <span class=\"token punctuation\">\\</span>\n    <span class=\"token parameter variable\">-device</span> virtserialport,chardev<span class=\"token operator\">=</span>bt,name<span class=\"token operator\">=</span>bt <span class=\"token punctuation\">\\</span>\n    <span class=\"token parameter variable\">-chardev</span> socket,id<span class=\"token operator\">=</span>bt,host<span class=\"token operator\">=</span>localhost,port<span class=\"token operator\">=</span><span class=\"token number\">6789</span> <span class=\"token punctuation\">\\</span>\n    <span class=\"token punctuation\">..</span>.</code></pre></div>\n</li>\n<li>\n<p><strong>The Result? Partial Success, Ultimate Failure:</strong> Using <code class=\"language-text\">lsof</code>, we could see the emulator's QEMU process <em>did</em> establish a TCP connection to the Bumble bridge! However, the Android Bluetooth stack <em>inside</em> the emulator never actually sent any HCI commands over it. Toggling Bluetooth in Android settings did nothing. The bridge logs remained silent after the initial connection. <strong>Dead end.</strong></p>\n</li>\n</ol>\n<h2>Attempt #2: The Default Netsim Bridge (Following Bumble Docs)</h2>\n<p>Bumble's documentation mentions bridging to the emulator's \"Netsim\" gRPC interface. Netsim (and its core, Root Canal) is the emulator's newer virtual Bluetooth controller system.</p>\n<ol>\n<li>\n<p><strong>Start the Bridge (Netsim Controller Mode):</strong> We configured the bridge to act as a Netsim controller, listening on the default gRPC port (8554), and connecting to the physical dongle.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># In Terminal 1:</span>\n<span class=\"token function\">sudo</span> python3 <span class=\"token parameter variable\">-m</span> bumble.apps.hci_bridge android-netsim:_:8554,mode<span class=\"token operator\">=</span>controller usb:0\n<span class=\"token comment\"># Output showed '>>> connected' twice - success connecting to USB and starting Netsim gRPC server.</span></code></pre></div>\n</li>\n<li>\n<p><strong>Launch Emulator (Default Backend):</strong> We reverted the launch script (still trying API 34) to remove the <code class=\"language-text\">-qemu</code> flags and added <code class=\"language-text\">-packet-streamer-endpoint default</code> to ensure it tried to use the Netsim backend.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># Snippet from launch script:</span>\nemulator <span class=\"token parameter variable\">-avd</span> <span class=\"token operator\">&lt;</span>avd_name<span class=\"token operator\">></span> <span class=\"token punctuation\">..</span>. <span class=\"token punctuation\">\\</span>\n    -packet-streamer-endpoint default <span class=\"token punctuation\">\\</span>\n    <span class=\"token punctuation\">..</span>.</code></pre></div>\n</li>\n<li>\n<p><strong>The Result? No Connection:</strong> This time, the emulator launched, but the Bumble bridge showed no signs of an incoming gRPC connection from the emulator. Checking the emulator logs didn't reveal obvious connection errors, but Bluetooth remained unusable. <strong>Another dead end.</strong></p>\n</li>\n</ol>\n<h2>Attempt #3: API Downgrade + Explicit Netsim Endpoint (The Winner!)</h2>\n<figure>\n  <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \">\n      <a class=\"gatsby-resp-image-link\" href=\"https://bdteo.github.io/static/cd1aa56ebd8947295c8b2ab1adab5b06/ac99c/featured-2.jpg\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 66.45569620253164%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAANABQDASIAAhEBAxEB/8QAFwAAAwEAAAAAAAAAAAAAAAAAAAQFAv/EABUBAQEAAAAAAAAAAAAAAAAAAAED/9oADAMBAAIQAxAAAAHDUViFaRAE/8QAGhABAAIDAQAAAAAAAAAAAAAAAgEDAAQREv/aAAgBAQABBQIvt+xPisWCQJ5LtlDP/8QAFhEBAQEAAAAAAAAAAAAAAAAAABJB/9oACAEDAQE/AcU//8QAFxEAAwEAAAAAAAAAAAAAAAAAAAESIf/aAAgBAgEBPwFrSD//xAAbEAADAAIDAAAAAAAAAAAAAAAAARECIhASIf/aAAgBAQAGPwJR6mvgu2SpSRcf/8QAGhABAAIDAQAAAAAAAAAAAAAAAQAhEBFBUf/aAAgBAQABPyEyA8RwUWv2PBtb0xCHI4dncf/aAAwDAQACAAMAAAAQHz//xAAWEQADAAAAAAAAAAAAAAAAAAABEBH/2gAIAQMBAT8QER//xAAYEQACAwAAAAAAAAAAAAAAAAAAEQExUf/aAAgBAgEBPxCRVQun/8QAGxABAAMBAQEBAAAAAAAAAAAAAQARITFBYfD/2gAIAQEAAT8QdIcFUc997FbSRXx8nEVD8bKm7V0lkBiK2DcYuuE//9k='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"Symbolic bridge between Apple and Android platforms\" title=\"\" src=\"https://bdteo.github.io/static/cd1aa56ebd8947295c8b2ab1adab5b06/828fb/featured-2.jpg\" srcset=\"https://bdteo.github.io/static/cd1aa56ebd8947295c8b2ab1adab5b06/ff44c/featured-2.jpg 158w,\nhttps://bdteo.github.io/static/cd1aa56ebd8947295c8b2ab1adab5b06/a6688/featured-2.jpg 315w,\nhttps://bdteo.github.io/static/cd1aa56ebd8947295c8b2ab1adab5b06/828fb/featured-2.jpg 630w,\nhttps://bdteo.github.io/static/cd1aa56ebd8947295c8b2ab1adab5b06/0ede0/featured-2.jpg 945w,\nhttps://bdteo.github.io/static/cd1aa56ebd8947295c8b2ab1adab5b06/3ac88/featured-2.jpg 1260w,\nhttps://bdteo.github.io/static/cd1aa56ebd8947295c8b2ab1adab5b06/ac99c/featured-2.jpg 1536w\" sizes=\"(max-width: 630px) 100vw, 630px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n  </a>\n    </span>\n  <figcaption>\n    Fig1. – A surreal landscape where failed network cables dangle between Apple and Android rock formations, while a single Bumble-branded rope bridge successfully connects the two, allowing glowing data packets to cross the divide.\n  </figcaption>\n</figure>\n<p>Web searches revealed general instability reports with Bluetooth on API 33/34 emulators and potential issues with how the emulator discovers or connects to the Netsim backend, especially when an external tool tries to intercept it. The key seemed to be <strong>explicitly telling the emulator where the Netsim gRPC server was</strong> and <strong>trying an older API level</strong>.</p>\n<ol>\n<li>\n<p><strong>Start the Bridge (Netsim Controller Mode, Explicit Port, <code class=\"language-text\">usb:0</code>):</strong> Same as Attempt #2, ensuring it listens on a known port (<code class=\"language-text\">8554</code>) and connects to the physical dongle using the index (<code class=\"language-text\">usb:0</code>) that worked reliably.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># In Terminal 1: (Keep this running!)</span>\n<span class=\"token function\">sudo</span> python3 <span class=\"token parameter variable\">-m</span> bumble.apps.hci_bridge android-netsim:_:8554,mode<span class=\"token operator\">=</span>controller usb:0</code></pre></div>\n</li>\n<li>\n<p><strong>Modify and Launch Emulator (API 32, Explicit Endpoint):</strong> We created an <strong>API 32 (Android 12L)</strong> AVD with Google Play Services (<code class=\"language-text\">gplay_32_arm</code>). We modified the launch script to target this AVD and, crucially, changed the <code class=\"language-text\">-packet-streamer-endpoint</code> flag from <code class=\"language-text\">default</code> to the <em>exact</em> address of our bridge.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># Snippet from the *successful* launch script (see full script below):</span>\n<span class=\"token assign-left variable\">API_LEVEL</span><span class=\"token operator\">=</span><span class=\"token string\">\"32\"</span>\n<span class=\"token assign-left variable\">AVD_NAME</span><span class=\"token operator\">=</span><span class=\"token string\">\"gplay_<span class=\"token variable\">${API_LEVEL}</span>_arm\"</span>\n<span class=\"token assign-left variable\">SYSTEM_IMAGE_PKG</span><span class=\"token operator\">=</span><span class=\"token string\">\"system-images;android-<span class=\"token variable\">${API_LEVEL}</span>;<span class=\"token variable\">${IMAGE_TAG}</span>;<span class=\"token variable\">${ARCH}</span>\"</span>\n<span class=\"token assign-left variable\">BUMBLE_NETSIM_GRPC_PORT</span><span class=\"token operator\">=</span><span class=\"token string\">\"8554\"</span>\n<span class=\"token punctuation\">..</span>.\nemulator <span class=\"token parameter variable\">-avd</span> <span class=\"token string\">\"<span class=\"token variable\">$AVD_NAME</span>\"</span> <span class=\"token punctuation\">..</span>. <span class=\"token punctuation\">\\</span>\n    -packet-streamer-endpoint <span class=\"token string\">\"localhost:<span class=\"token variable\">$BUMBLE_NETSIM_GRPC_PORT</span>\"</span> <span class=\"token punctuation\">\\</span>\n    <span class=\"token punctuation\">..</span>.</code></pre></div>\n</li>\n<li>\n<p><strong>The Result? Success!</strong> This time, it worked!</p>\n<ul>\n<li>The <code class=\"language-text\">bumble-hci-bridge</code> terminal started showing gRPC connection logs from the emulator shortly after launch.</li>\n<li>Once the emulator booted, toggling Bluetooth ON in Android Settings resulted in a flood of HCI commands (Reset, Read Version, Set Event Mask, etc.) appearing in the bridge terminal.</li>\n<li>Scanning for devices within the emulator successfully used the Mac's physical Bluetooth radio via the ASUS dongle!</li>\n</ul>\n</li>\n</ol>\n<h2>The Winning Recipe: Step-by-Step</h2>\n<p>Here's the exact procedure that worked on my M1 Mac Pro with an external ASUS USB-BT500 dongle:</p>\n<ol>\n<li>\n<p><strong>Install Bumble:</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">python3 <span class=\"token parameter variable\">-m</span> pip <span class=\"token function\">install</span> bumble\n<span class=\"token comment\"># Potentially install libusb if needed: brew install libusb</span></code></pre></div>\n</li>\n<li>\n<p><strong>(Optional but Recommended) Disable macOS Native USB BT Handling:</strong> Run <em>once</em> and <strong>reboot</strong>.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">sudo</span> nvram <span class=\"token assign-left variable\">bluetoothHostControllerSwitchBehavior</span><span class=\"token operator\">=</span><span class=\"token string\">\"never\"</span></code></pre></div>\n</li>\n<li>\n<p><strong>Start the Bumble Netsim Bridge:</strong> Open a terminal and run (keep it running):</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">sudo</span> python3 <span class=\"token parameter variable\">-m</span> bumble.apps.hci_bridge android-netsim:_:8554,mode<span class=\"token operator\">=</span>controller usb:0</code></pre></div>\n<p><em>(Verify it shows <code class=\"language-text\">>>> connected</code> twice).</em></p>\n</li>\n<li>\n<p><strong>Prepare the Emulator Launch Script:</strong> Save the <em>full script</em> provided below as <code class=\"language-text\">launch_gapps_avd_api32.sh</code> (or similar). Make sure it targets an <strong>API 32</strong> AVD (it will create one named <code class=\"language-text\">gplay_32_arm</code> if it doesn't exist) and explicitly uses <code class=\"language-text\">-packet-streamer-endpoint localhost:8554</code>. Make it executable (<code class=\"language-text\">chmod +x launch_gapps_avd_api32.sh</code>).</p>\n</li>\n<li>\n<p><strong>Run the Launch Script:</strong> Open a <em>new</em> terminal and execute the script:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">./launch_gapps_avd_api32.sh</code></pre></div>\n</li>\n<li>\n<p><strong>Verify:</strong> Once the emulator boots:</p>\n<ul>\n<li>Check the <code class=\"language-text\">bumble-hci-bridge</code> terminal for gRPC and HCI traffic.</li>\n<li>Go to Android Settings -> Bluetooth and toggle it ON.</li>\n<li>Try scanning or pairing.</li>\n</ul>\n</li>\n</ol>\n<h2>The Successful Launch Script (API 32, Explicit Netsim Endpoint)</h2>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token shebang important\">#!/bin/bash</span>\n\n<span class=\"token comment\"># Script to setup and launch a Google Play Android emulator (API 32) on macOS M1/ARM64</span>\n<span class=\"token comment\"># Uses explicit Netsim endpoint for Bumble bridge compatibility.</span>\n\n<span class=\"token builtin class-name\">set</span> <span class=\"token parameter variable\">-e</span> <span class=\"token comment\"># Exit immediately if a command exits with a non-zero status.</span>\n\n<span class=\"token comment\"># --- Configuration ---</span>\n<span class=\"token assign-left variable\">API_LEVEL</span><span class=\"token operator\">=</span><span class=\"token string\">\"32\"</span> <span class=\"token comment\"># Target Android API Level (Android 12L)</span>\n<span class=\"token assign-left variable\">AVD_NAME</span><span class=\"token operator\">=</span><span class=\"token string\">\"gplay_<span class=\"token variable\">${API_LEVEL}</span>_arm\"</span> <span class=\"token comment\"># Name for the Android Virtual Device</span>\n<span class=\"token assign-left variable\">IMAGE_TAG</span><span class=\"token operator\">=</span><span class=\"token string\">\"google_apis_playstore\"</span> <span class=\"token comment\"># Image type with Google Play Store</span>\n<span class=\"token assign-left variable\">ARCH</span><span class=\"token operator\">=</span><span class=\"token string\">\"arm64-v8a\"</span> <span class=\"token comment\"># Architecture for Apple Silicon</span>\n<span class=\"token assign-left variable\">SYSTEM_IMAGE_PKG</span><span class=\"token operator\">=</span><span class=\"token string\">\"system-images;android-<span class=\"token variable\">${API_LEVEL}</span>;<span class=\"token variable\">${IMAGE_TAG}</span>;<span class=\"token variable\">${ARCH}</span>\"</span>\n<span class=\"token assign-left variable\">DEVICE_DEF</span><span class=\"token operator\">=</span><span class=\"token string\">\"pixel_6a\"</span> <span class=\"token comment\"># A common modern Pixel device definition</span>\n<span class=\"token assign-left variable\">BUMBLE_NETSIM_GRPC_PORT</span><span class=\"token operator\">=</span><span class=\"token string\">\"8554\"</span> <span class=\"token comment\"># Port where bumble-hci-bridge Netsim controller is listening</span>\n\n<span class=\"token comment\"># --- Find Android SDK ---</span>\n<span class=\"token assign-left variable\">ANDROID_SDK_ROOT</span><span class=\"token operator\">=</span><span class=\"token string\">\"<span class=\"token variable\">${ANDROID_HOME<span class=\"token operator\">:-</span>${ANDROID_SDK_ROOT<span class=\"token operator\">:-</span>$HOME<span class=\"token operator\">/</span>Library<span class=\"token operator\">/</span>Android<span class=\"token operator\">/</span>sdk}</span>}\"</span>\n\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span> <span class=\"token operator\">!</span> <span class=\"token parameter variable\">-d</span> <span class=\"token string\">\"<span class=\"token variable\">$ANDROID_SDK_ROOT</span>\"</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span>\n    <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"❌ Error: Android SDK not found at '<span class=\"token variable\">$ANDROID_SDK_ROOT</span>'\"</span> <span class=\"token operator\">></span><span class=\"token file-descriptor important\">&amp;2</span>\n    <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"   Please install Android Studio or set ANDROID_HOME/ANDROID_SDK_ROOT.\"</span> <span class=\"token operator\">></span><span class=\"token file-descriptor important\">&amp;2</span>\n    <span class=\"token builtin class-name\">exit</span> <span class=\"token number\">1</span>\n<span class=\"token keyword\">fi</span>\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"▶️ Using Android SDK at: <span class=\"token variable\">$ANDROID_SDK_ROOT</span>\"</span>\n\n<span class=\"token comment\"># --- Define Tool Paths ---</span>\n<span class=\"token assign-left variable\">CMDLINE_TOOLS_BIN</span><span class=\"token operator\">=</span><span class=\"token string\">\"<span class=\"token variable\">$ANDROID_SDK_ROOT</span>/cmdline-tools/latest/bin\"</span>\n<span class=\"token assign-left variable\">PLATFORM_TOOLS_DIR</span><span class=\"token operator\">=</span><span class=\"token string\">\"<span class=\"token variable\">$ANDROID_SDK_ROOT</span>/platform-tools\"</span>\n<span class=\"token assign-left variable\">EMULATOR_DIR</span><span class=\"token operator\">=</span><span class=\"token string\">\"<span class=\"token variable\">$ANDROID_SDK_ROOT</span>/emulator\"</span>\n\n<span class=\"token assign-left variable\">SDKMANAGER</span><span class=\"token operator\">=</span><span class=\"token string\">\"<span class=\"token variable\">$CMDLINE_TOOLS_BIN</span>/sdkmanager\"</span>\n<span class=\"token assign-left variable\">AVDMANAGER</span><span class=\"token operator\">=</span><span class=\"token string\">\"<span class=\"token variable\">$CMDLINE_TOOLS_BIN</span>/avdmanager\"</span>\n<span class=\"token assign-left variable\">EMULATOR</span><span class=\"token operator\">=</span><span class=\"token string\">\"<span class=\"token variable\">$EMULATOR_DIR</span>/emulator\"</span>\n<span class=\"token assign-left variable\">ADB</span><span class=\"token operator\">=</span><span class=\"token string\">\"<span class=\"token variable\">$PLATFORM_TOOLS_DIR</span>/adb\"</span>\n\n<span class=\"token comment\"># --- Check Essential Tools ---</span>\n<span class=\"token keyword\">if</span> <span class=\"token operator\">!</span> <span class=\"token builtin class-name\">command</span> <span class=\"token parameter variable\">-v</span> sdkmanager <span class=\"token operator\">&amp;></span> /dev/null<span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span> <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"❌ Error: sdkmanager not found. Check SDK Command-line Tools installation and PATH.\"</span> <span class=\"token operator\">></span><span class=\"token file-descriptor important\">&amp;2</span><span class=\"token punctuation\">;</span> <span class=\"token builtin class-name\">exit</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">fi</span>\n<span class=\"token keyword\">if</span> <span class=\"token operator\">!</span> <span class=\"token builtin class-name\">command</span> <span class=\"token parameter variable\">-v</span> avdmanager <span class=\"token operator\">&amp;></span> /dev/null<span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span> <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"❌ Error: avdmanager not found. Check SDK Command-line Tools installation and PATH.\"</span> <span class=\"token operator\">></span><span class=\"token file-descriptor important\">&amp;2</span><span class=\"token punctuation\">;</span> <span class=\"token builtin class-name\">exit</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">fi</span>\n<span class=\"token keyword\">if</span> <span class=\"token operator\">!</span> <span class=\"token builtin class-name\">command</span> <span class=\"token parameter variable\">-v</span> emulator <span class=\"token operator\">&amp;></span> /dev/null<span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span> <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"❌ Error: emulator not found. Check Android Emulator installation and PATH.\"</span> <span class=\"token operator\">></span><span class=\"token file-descriptor important\">&amp;2</span><span class=\"token punctuation\">;</span> <span class=\"token builtin class-name\">exit</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">fi</span>\n<span class=\"token keyword\">if</span> <span class=\"token operator\">!</span> <span class=\"token builtin class-name\">command</span> <span class=\"token parameter variable\">-v</span> adb <span class=\"token operator\">&amp;></span> /dev/null<span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span> <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"❌ Error: adb not found. Check SDK Platform-Tools installation and PATH.\"</span> <span class=\"token operator\">></span><span class=\"token file-descriptor important\">&amp;2</span><span class=\"token punctuation\">;</span> <span class=\"token builtin class-name\">exit</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">fi</span>\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"✅ Basic SDK tools found in PATH.\"</span>\n\n<span class=\"token comment\"># --- Stop Currently Running Emulators ---</span>\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"▶️ Stopping any currently running emulators...\"</span>\n<span class=\"token assign-left variable\">RUNNING_EMULATORS</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span>adb devices <span class=\"token operator\">|</span> <span class=\"token function\">grep</span> <span class=\"token string\">'emulator-'</span> <span class=\"token operator\">|</span> <span class=\"token function\">cut</span> <span class=\"token parameter variable\">-f1</span><span class=\"token variable\">)</span></span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span> <span class=\"token parameter variable\">-n</span> <span class=\"token string\">\"<span class=\"token variable\">$RUNNING_EMULATORS</span>\"</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span>\n    <span class=\"token keyword\">for</span> <span class=\"token for-or-select variable\">emu_id</span> <span class=\"token keyword\">in</span> <span class=\"token variable\">$RUNNING_EMULATORS</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">do</span>\n        <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"   Stopping <span class=\"token variable\">$emu_id</span>...\"</span>\n        adb <span class=\"token parameter variable\">-s</span> <span class=\"token string\">\"<span class=\"token variable\">$emu_id</span>\"</span> emu <span class=\"token function\">kill</span> <span class=\"token operator\">||</span> <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"   (Failed to kill <span class=\"token variable\">$emu_id</span>, may already be stopped)\"</span>\n        <span class=\"token function\">sleep</span> <span class=\"token number\">1</span> <span class=\"token comment\"># Small delay</span>\n    <span class=\"token keyword\">done</span>\n    <span class=\"token comment\"># Give ADB server time to recognize disconnection</span>\n    <span class=\"token function\">sleep</span> <span class=\"token number\">3</span>\n    <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"   Emulators stopped.\"</span>\n<span class=\"token keyword\">else</span>\n    <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"   No emulators appear to be running according to 'adb devices'.\"</span>\n<span class=\"token keyword\">fi</span>\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"✅ Emulator check/stop finished.\"</span>\n\n\n<span class=\"token comment\"># --- Install/Update Required SDK Packages ---</span>\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"▶️ Ensuring required SDK packages are installed...\"</span>\n<span class=\"token comment\"># Accept licenses non-interactively</span>\n<span class=\"token function\">yes</span> <span class=\"token operator\">|</span> sdkmanager <span class=\"token parameter variable\">--licenses</span> <span class=\"token operator\">></span> /dev/null <span class=\"token operator\">||</span> <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"   (Ignoring potential license script errors)\"</span>\n\n<span class=\"token comment\"># Install platform-tools, emulator</span>\nsdkmanager <span class=\"token string\">\"platform-tools\"</span> <span class=\"token string\">\"emulator\"</span>\n\n<span class=\"token comment\"># Install the Google Play system image for API 32</span>\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"▶️ Attempting to install/update Google Play system image: <span class=\"token variable\">$SYSTEM_IMAGE_PKG</span>\"</span>\n<span class=\"token keyword\">if</span> <span class=\"token operator\">!</span> sdkmanager <span class=\"token string\">\"<span class=\"token variable\">$SYSTEM_IMAGE_PKG</span>\"</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span>\n    <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"❌ Error: Failed to install required system image '<span class=\"token variable\">$SYSTEM_IMAGE_PKG</span>'.\"</span> <span class=\"token operator\">></span><span class=\"token file-descriptor important\">&amp;2</span>\n    <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"   Please check available images using: sdkmanager --list | grep 'system-images;android-<span class=\"token variable\">${API_LEVEL}</span>;.*<span class=\"token variable\">${ARCH}</span>'\"</span> <span class=\"token operator\">></span><span class=\"token file-descriptor important\">&amp;2</span>\n    <span class=\"token builtin class-name\">exit</span> <span class=\"token number\">1</span>\n<span class=\"token keyword\">fi</span>\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"✅ System image package '<span class=\"token variable\">$SYSTEM_IMAGE_PKG</span>' present.\"</span>\n\n<span class=\"token comment\"># --- Check if AVD Exists, Create ONLY if Missing ---</span>\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"▶️ Ensuring AVD '<span class=\"token variable\">$AVD_NAME</span>' exists...\"</span>\n<span class=\"token keyword\">if</span> <span class=\"token operator\">!</span> avdmanager list avd <span class=\"token parameter variable\">--compact</span> <span class=\"token operator\">|</span> <span class=\"token function\">grep</span> <span class=\"token parameter variable\">-q</span> <span class=\"token string\">\"^<span class=\"token variable\">${AVD_NAME}</span>$\"</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span>\n    <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"   AVD '<span class=\"token variable\">$AVD_NAME</span>' not found. Creating...\"</span>\n    <span class=\"token comment\"># Using 'echo no' usually prevents hardware profile creation prompts. Pipe empty string for potential licenses.</span>\n    <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"\"</span> <span class=\"token operator\">|</span> avdmanager create avd <span class=\"token parameter variable\">--force</span> <span class=\"token parameter variable\">--name</span> <span class=\"token string\">\"<span class=\"token variable\">$AVD_NAME</span>\"</span> <span class=\"token parameter variable\">--package</span> <span class=\"token string\">\"<span class=\"token variable\">$SYSTEM_IMAGE_PKG</span>\"</span> <span class=\"token parameter variable\">--device</span> <span class=\"token string\">\"<span class=\"token variable\">$DEVICE_DEF</span>\"</span> <span class=\"token parameter variable\">--sdcard</span> 512M <span class=\"token operator\">||</span> <span class=\"token punctuation\">{</span>\n         <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"❌ Error: Failed to create AVD '<span class=\"token variable\">$AVD_NAME</span>'.\"</span> <span class=\"token operator\">></span><span class=\"token file-descriptor important\">&amp;2</span>\n         <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"   Maybe the device definition '<span class=\"token variable\">$DEVICE_DEF</span>' is invalid for this image?\"</span> <span class=\"token operator\">></span><span class=\"token file-descriptor important\">&amp;2</span>\n         <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"   Check available devices: avdmanager list device\"</span> <span class=\"token operator\">></span><span class=\"token file-descriptor important\">&amp;2</span>\n         <span class=\"token builtin class-name\">exit</span> <span class=\"token number\">1</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"✅ AVD '<span class=\"token variable\">$AVD_NAME</span>' created.\"</span>\n<span class=\"token keyword\">else</span>\n    <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"✅ AVD '<span class=\"token variable\">$AVD_NAME</span>' already exists. Will reuse.\"</span>\n<span class=\"token keyword\">fi</span>\n\n\n<span class=\"token comment\"># --- Launch Emulator ---</span>\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"▶️ Launching existing/new emulator: '<span class=\"token variable\">$AVD_NAME</span>' (pointing to Bumble Netsim bridge on localhost:<span class=\"token variable\">$BUMBLE_NETSIM_GRPC_PORT</span>)...\"</span>\n<span class=\"token assign-left variable\">EMULATOR_LOG</span><span class=\"token operator\">=</span><span class=\"token string\">\"emulator-<span class=\"token variable\">$AVD_NAME</span>.log\"</span> <span class=\"token comment\"># Log file name updated for API 32 AVD</span>\n<span class=\"token comment\"># Google Play images often need a writable system partition</span>\n<span class=\"token comment\"># Explicitly point packet streamer to localhost:8554 where bridge is listening</span>\n<span class=\"token function\">nohup</span> emulator <span class=\"token parameter variable\">-avd</span> <span class=\"token string\">\"<span class=\"token variable\">$AVD_NAME</span>\"</span> -no-snapshot-load <span class=\"token parameter variable\">-gpu</span> auto -show-kernel -writable-system <span class=\"token punctuation\">\\</span>\n    -packet-streamer-endpoint <span class=\"token string\">\"localhost:<span class=\"token variable\">$BUMBLE_NETSIM_GRPC_PORT</span>\"</span> <span class=\"token punctuation\">\\</span>\n    <span class=\"token operator\">></span> <span class=\"token string\">\"<span class=\"token variable\">$EMULATOR_LOG</span>\"</span> <span class=\"token operator\"><span class=\"token file-descriptor important\">2</span>></span><span class=\"token file-descriptor important\">&amp;1</span> <span class=\"token operator\">&amp;</span>\n<span class=\"token assign-left variable\">EMULATOR_PID</span><span class=\"token operator\">=</span><span class=\"token variable\">$!</span>\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"   Emulator starting in background (PID: <span class=\"token variable\">$EMULATOR_PID</span>). Log: <span class=\"token variable\">$EMULATOR_LOG</span>\"</span>\n<span class=\"token builtin class-name\">echo</span> <span class=\"token parameter variable\">-n</span> <span class=\"token string\">\"   Waiting for emulator to appear in ADB...\"</span>\n\n<span class=\"token comment\"># Wait for the emulator device to show up in adb</span>\n<span class=\"token assign-left variable\">WAIT_ADB_TIMEOUT</span><span class=\"token operator\">=</span><span class=\"token number\">90</span> <span class=\"token comment\"># Increase timeout slightly for GPlay images</span>\n<span class=\"token assign-left variable\"><span class=\"token environment constant\">SECONDS</span></span><span class=\"token operator\">=</span><span class=\"token number\">0</span>\n<span class=\"token assign-left variable\">EMULATOR_ID</span><span class=\"token operator\">=</span><span class=\"token string\">\"\"</span> <span class=\"token comment\"># Reset variable</span>\n<span class=\"token keyword\">while</span> <span class=\"token punctuation\">[</span> <span class=\"token environment constant\">$SECONDS</span> <span class=\"token parameter variable\">-lt</span> <span class=\"token variable\">$WAIT_ADB_TIMEOUT</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">do</span>\n    <span class=\"token comment\"># Find the *new* emulator ID</span>\n    <span class=\"token assign-left variable\">CURRENT_EMU_ID</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span>adb devices <span class=\"token operator\">|</span> <span class=\"token function\">grep</span> <span class=\"token string\">'emulator-'</span> <span class=\"token operator\">|</span> <span class=\"token function\">head</span> <span class=\"token parameter variable\">-n</span> <span class=\"token number\">1</span> <span class=\"token operator\">|</span> <span class=\"token function\">cut</span> <span class=\"token parameter variable\">-f1</span><span class=\"token variable\">)</span></span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span> <span class=\"token parameter variable\">-n</span> <span class=\"token string\">\"<span class=\"token variable\">$CURRENT_EMU_ID</span>\"</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span>\n        <span class=\"token assign-left variable\">EMULATOR_ID</span><span class=\"token operator\">=</span><span class=\"token string\">\"<span class=\"token variable\">$CURRENT_EMU_ID</span>\"</span>\n        <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\" Found (<span class=\"token variable\">$EMULATOR_ID</span>)!\"</span>\n        <span class=\"token builtin class-name\">break</span>\n    <span class=\"token keyword\">fi</span>\n    <span class=\"token function\">sleep</span> <span class=\"token number\">2</span>\n    <span class=\"token assign-left variable\"><span class=\"token environment constant\">SECONDS</span></span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$((</span>SECONDS <span class=\"token operator\">+</span> <span class=\"token number\">2</span><span class=\"token variable\">))</span></span>\n    <span class=\"token builtin class-name\">echo</span> <span class=\"token parameter variable\">-n</span> <span class=\"token string\">\".\"</span>\n<span class=\"token keyword\">done</span>\n\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span> <span class=\"token parameter variable\">-z</span> <span class=\"token string\">\"<span class=\"token variable\">$EMULATOR_ID</span>\"</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span>\n    <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"\"</span>\n    <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"❌ Error: Emulator did not appear in ADB within <span class=\"token variable\">$WAIT_ADB_TIMEOUT</span> seconds.\"</span> <span class=\"token operator\">></span><span class=\"token file-descriptor important\">&amp;2</span>\n    <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"   Check logs: <span class=\"token variable\">$EMULATOR_LOG</span>\"</span> <span class=\"token operator\">></span><span class=\"token file-descriptor important\">&amp;2</span>\n    <span class=\"token comment\"># Try to kill the process if it's still lingering</span>\n    <span class=\"token function\">kill</span> <span class=\"token variable\">$EMULATOR_PID</span> <span class=\"token operator\"><span class=\"token file-descriptor important\">2</span>></span>/dev/null <span class=\"token operator\">||</span> <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"   (Emulator process <span class=\"token variable\">$EMULATOR_PID</span> may have already exited)\"</span>\n    <span class=\"token builtin class-name\">exit</span> <span class=\"token number\">1</span>\n<span class=\"token keyword\">fi</span>\n\n\n<span class=\"token comment\"># --- Wait for Boot Completion ---</span>\n<span class=\"token builtin class-name\">echo</span> <span class=\"token parameter variable\">-n</span> <span class=\"token string\">\"▶️ Waiting for Android system to fully boot (Google Play images can take longer)...\"</span>\n<span class=\"token assign-left variable\">BOOT_TIMEOUT</span><span class=\"token operator\">=</span><span class=\"token number\">240</span> <span class=\"token comment\"># Increase timeout significantly for GPlay images</span>\n<span class=\"token assign-left variable\"><span class=\"token environment constant\">SECONDS</span></span><span class=\"token operator\">=</span><span class=\"token number\">0</span>\n<span class=\"token keyword\">while</span> <span class=\"token punctuation\">[</span> <span class=\"token environment constant\">$SECONDS</span> <span class=\"token parameter variable\">-lt</span> <span class=\"token variable\">$BOOT_TIMEOUT</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">do</span>\n    <span class=\"token comment\"># Check if device is online first</span>\n    <span class=\"token assign-left variable\">DEVICE_STATE</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span>adb <span class=\"token parameter variable\">-s</span> <span class=\"token string\">\"<span class=\"token variable\">$EMULATOR_ID</span>\"</span> get-state <span class=\"token operator\"><span class=\"token file-descriptor important\">2</span>></span>/dev/null<span class=\"token variable\">)</span></span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span> <span class=\"token string\">\"<span class=\"token variable\">$DEVICE_STATE</span>\"</span> <span class=\"token operator\">!=</span> <span class=\"token string\">\"device\"</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span>\n       <span class=\"token builtin class-name\">echo</span> <span class=\"token parameter variable\">-n</span> <span class=\"token string\">\"s(<span class=\"token variable\">$DEVICE_STATE</span>)\"</span> <span class=\"token comment\"># State not ready</span>\n       <span class=\"token function\">sleep</span> <span class=\"token number\">5</span>\n       <span class=\"token assign-left variable\"><span class=\"token environment constant\">SECONDS</span></span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$((</span>SECONDS <span class=\"token operator\">+</span> <span class=\"token number\">5</span><span class=\"token variable\">))</span></span>\n       <span class=\"token builtin class-name\">continue</span>\n    <span class=\"token keyword\">fi</span>\n\n    <span class=\"token comment\"># Check boot completed property</span>\n    <span class=\"token assign-left variable\">BOOT_COMPLETED</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span>adb <span class=\"token parameter variable\">-s</span> <span class=\"token string\">\"<span class=\"token variable\">$EMULATOR_ID</span>\"</span> shell getprop sys.boot_completed <span class=\"token operator\"><span class=\"token file-descriptor important\">2</span>></span>/dev/null <span class=\"token operator\">|</span> <span class=\"token function\">tr</span> <span class=\"token parameter variable\">-d</span> <span class=\"token string\">'\n'</span><span class=\"token variable\">)</span></span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span> <span class=\"token string\">\"<span class=\"token variable\">$BOOT_COMPLETED</span>\"</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"1\"</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span>\n        <span class=\"token comment\"># Double check package manager is ready too for GPlay images</span>\n        <span class=\"token assign-left variable\">PM_READY</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span>adb <span class=\"token parameter variable\">-s</span> <span class=\"token string\">\"<span class=\"token variable\">$EMULATOR_ID</span>\"</span> shell pm get-install-location <span class=\"token operator\"><span class=\"token file-descriptor important\">2</span>></span>/dev/null<span class=\"token variable\">)</span></span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span> <span class=\"token string\">\"<span class=\"token variable\">$PM_READY</span>\"</span> <span class=\"token operator\">==</span> *<span class=\"token string\">\"0\"</span>* <span class=\"token operator\">||</span> <span class=\"token string\">\"<span class=\"token variable\">$PM_READY</span>\"</span> <span class=\"token operator\">==</span> *<span class=\"token string\">\"1\"</span>* <span class=\"token operator\">||</span> <span class=\"token string\">\"<span class=\"token variable\">$PM_READY</span>\"</span> <span class=\"token operator\">==</span> *<span class=\"token string\">\"2\"</span>* <span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span> <span class=\"token comment\"># Check if pm command gives valid output</span>\n            <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\" Booted!\"</span>\n            <span class=\"token builtin class-name\">break</span>\n        <span class=\"token keyword\">else</span>\n            <span class=\"token builtin class-name\">echo</span> <span class=\"token parameter variable\">-n</span> <span class=\"token string\">\"p(pm not ready)\"</span> <span class=\"token comment\"># Package Manager not ready</span>\n        <span class=\"token keyword\">fi</span>\n    <span class=\"token keyword\">else</span>\n         <span class=\"token builtin class-name\">echo</span> <span class=\"token parameter variable\">-n</span> <span class=\"token string\">\"b(booting)\"</span> <span class=\"token comment\"># Boot not completed</span>\n    <span class=\"token keyword\">fi</span>\n    <span class=\"token function\">sleep</span> <span class=\"token number\">5</span>\n    <span class=\"token assign-left variable\"><span class=\"token environment constant\">SECONDS</span></span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$((</span>SECONDS <span class=\"token operator\">+</span> <span class=\"token number\">5</span><span class=\"token variable\">))</span></span>\n<span class=\"token keyword\">done</span>\n\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span> <span class=\"token environment constant\">$SECONDS</span> <span class=\"token parameter variable\">-ge</span> <span class=\"token variable\">$BOOT_TIMEOUT</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span>\n    <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"\"</span>\n    <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"❌ Error: Android system did not fully boot within <span class=\"token variable\">$BOOT_TIMEOUT</span> seconds.\"</span> <span class=\"token operator\">></span><span class=\"token file-descriptor important\">&amp;2</span>\n    <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"   Emulator might be stuck. Check logs (<span class=\"token variable\">$EMULATOR_LOG</span>) or try launching manually.\"</span> <span class=\"token operator\">></span><span class=\"token file-descriptor important\">&amp;2</span>\n    <span class=\"token comment\"># Don't exit here, user might want to interact with stuck emulator</span>\n<span class=\"token keyword\">fi</span>\n\n\n<span class=\"token comment\"># --- Final Instructions ---</span>\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"---\"</span>\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"✅ Google Play Emulator '<span class=\"token variable\">$AVD_NAME</span>' (API <span class=\"token variable\">$API_LEVEL</span>) (<span class=\"token variable\">$EMULATOR_ID</span>) should be running.\"</span>\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"   Bluetooth should be using the Netsim backend at localhost:<span class=\"token variable\">$BUMBLE_NETSIM_GRPC_PORT</span> (intercepted by Bumble).\"</span>\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"   Connect shell:   adb -s <span class=\"token variable\">$EMULATOR_ID</span> shell\"</span>\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"   Install APK:     adb -s <span class=\"token variable\">$EMULATOR_ID</span> install /path/to/your.apk\"</span>\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"   Stop emulator:   adb -s <span class=\"token variable\">$EMULATOR_ID</span> emu kill\"</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span> <span class=\"token parameter variable\">-n</span> <span class=\"token string\">\"<span class=\"token variable\">$EMULATOR_PID</span>\"</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span> <span class=\"token comment\"># Only show PID if we launched it</span>\n    <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"   Kill Process:    kill <span class=\"token variable\">$EMULATOR_PID</span>\"</span>\n<span class=\"token keyword\">fi</span>\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"   NOTE: Google Play Services may need updates inside the emulator.\"</span>\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"---\"</span>\n\n<span class=\"token builtin class-name\">exit</span> <span class=\"token number\">0</span></code></pre></div>\n<h2>Key Takeaways for M1 Mac + Emulator + Bumble</h2>\n<ul>\n<li><strong>API Level Matters:</strong> Newer isn't always better for emulator compatibility, especially with complex features like Bluetooth bridging. API 32 seemed more stable for this than API 34 in my tests.</li>\n<li><strong>Explicit Endpoints:</strong> Don't rely on <code class=\"language-text\">-packet-streamer-endpoint default</code> when using an external bridge like Bumble's Netsim controller mode. Explicitly point the emulator to <code class=\"language-text\">localhost:&lt;port></code> where your bridge is listening.</li>\n<li><strong>Netsim Bridge > QEMU Socket:</strong> The <code class=\"language-text\">android-netsim</code> bridge mode seems more likely to work with modern emulators than the lower-level <code class=\"language-text\">-qemu -chardev socket</code> method, even though the socket method <em>can</em> establish a TCP link.</li>\n<li><strong><code class=\"language-text\">usb:0</code> vs VID:PID:</strong> On macOS/M1, identifying USB devices can be quirky. If specifying the exact VID:PID fails unexpectedly, try using the index <code class=\"language-text\">usb:0</code> (assuming it's the primary/intended device).</li>\n<li><strong>Persistence Pays Off:</strong> This took several attempts, combining insights from documentation, web searches, and iterative testing. Don't give up easily!</li>\n</ul>\n<p>Hopefully, sharing this specific, working configuration saves other developers hours of frustration. Happy coding (and bridging)!</p>","frontmatter":{"title":"M1 Mac + Android Emulator Bluetooth Nightmare? Bumble & API 32 Saved My Sanity!","date":"April 14, 2025","description":"Struggling to get Bluetooth working between your M1 Mac and the Android Emulator? Tried everything? This developer's journey reveals the specific Bumble setup and emulator flags that finally worked!","imageCaption":"Visualizing the complex bridge needed to connect M1 Mac Bluetooth to the Android Emulator.","featuredImage":{"childImageSharp":{"gatsbyImageData":{"layout":"fullWidth","backgroundColor":"#080808","images":{"fallback":{"src":"https://bdteo.github.io/static/168463a17f9c2441d153dcee3bdf8990/83638/featured.jpg","srcSet":"https://bdteo.github.io/static/168463a17f9c2441d153dcee3bdf8990/7284f/featured.jpg 750w,\nhttps://bdteo.github.io/static/168463a17f9c2441d153dcee3bdf8990/29ba9/featured.jpg 1080w,\nhttps://bdteo.github.io/static/168463a17f9c2441d153dcee3bdf8990/c8896/featured.jpg 1366w,\nhttps://bdteo.github.io/static/168463a17f9c2441d153dcee3bdf8990/83638/featured.jpg 1536w","sizes":"100vw"},"sources":[{"srcSet":"https://bdteo.github.io/static/168463a17f9c2441d153dcee3bdf8990/57584/featured.webp 750w,\nhttps://bdteo.github.io/static/168463a17f9c2441d153dcee3bdf8990/984df/featured.webp 1080w,\nhttps://bdteo.github.io/static/168463a17f9c2441d153dcee3bdf8990/4a276/featured.webp 1366w,\nhttps://bdteo.github.io/static/168463a17f9c2441d153dcee3bdf8990/7db9c/featured.webp 1536w","type":"image/webp","sizes":"100vw"}]},"width":1,"height":0.6666666666666666}}}}},"previous":{"fields":{"slug":"/claude-code-transformed-my-blog-design-in-minutes/"},"frontmatter":{"title":"I Let Claude Code Redesign My Gatsby Blog and the Results Are Mind-Blowing"}},"next":null},"pageContext":{"id":"011322ec-73d3-5565-acd3-379f57e99816","previousPostId":"6d3ddfc4-21d4-5918-bb8d-fa04fa8fd4fa","nextPostId":null}},"staticQueryHashes":["2841359383","2923011943"],"slicesMap":{}}